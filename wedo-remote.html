<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeDo 2.0 Remote Control</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Enforce full-screen height and hide scrollbars */
        html, body { 
            height: 100vh; 
            width: 100vw;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        body::-webkit-scrollbar { display: none; } /* Chrome, Safari, Opera */
        
        /* Center content vertically and horizontally */
        body { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 1rem;
        }

        /* Custom styling for the buttons to give a LEGO feel */
        .lego-btn {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 0 0 #1f2937; /* Base shadow for lift */
        }
        .lego-btn:active {
            box-shadow: 0 1px 0 0 #1f2937; /* Reduced shadow for press effect */
            transform: translateY(3px);
        }
        
        /* Status Dot for Port Detection */
        .status-dot {
            height: 12px;
            width: 12px;
            background-color: #d1d5db; /* gray-300 */
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            transition: all 0.3s ease;
        }
        .status-dot.active {
            background-color: #22c55e; /* green-500 */
            box-shadow: 0 0 8px #22c55e;
        }

        /* Joystick Track Styles */
        .joystick-track {
            background-size: 100% 100%;
            background-position: center;
            border: 2px solid #ccc;
            /* Initial Vertical Style */
            background: linear-gradient(to top, #f87171 0%, #fca5a5 49%, #86efac 51%, #4ade80 100%);
        }
        
        /* Joystick Handle Styles */
        .joystick-handle {
            width: 50px;
            height: 50px;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 10;
            user-select: none;
            touch-action: none; /* Prevents scrolling on touch screens */
            /* Initial center position for handle */
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
        }
        
        /* Ensure the main container can scroll if content exceeds screen size (e.g., in landscape mode on small phones) */
        .main-container {
            max-height: 100%;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="main-container w-full max-w-lg sm:max-w-4xl bg-white p-6 rounded-xl shadow-2xl space-y-6">
        
        <!-- Header -->
        <div class="relative">
            <h1 class="text-3xl font-extrabold text-blue-600 text-center">WeDo 2.0 Remote</h1>
            <p class="text-sm text-gray-500 text-center">Configurable Motor Control</p>
        </div>

        <!-- Connection Status & Controls (Collapsible) -->
        <div id="connectionWrapper" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
            
            <!-- Connection Button (Visible when disconnected) -->
            <button onclick="connectHub()" id="connectBtn" 
                class="lego-btn w-full py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
                Connect WeDo Hub
            </button>
            
            <!-- Toggle Button (Visible when connected) -->
            <button id="toggleControlsBtn" onclick="toggleConnectionControls()" 
                class="hidden w-full py-2 bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded-lg text-sm transition duration-150 ease-in-out">
                Show Controls
            </button>

            <!-- Inner Controls (Toggled visibility) -->
            <div id="connectionControlsInner" class="space-y-4 hidden">
                <div id="status" class="text-center font-bold text-lg text-red-500">
                    Disconnected
                </div>
                
                <button onclick="disconnectHub()" id="disconnectBtn" 
                    class="lego-btn w-full py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
                    Disconnect
                </button>
            </div>
        </div>
        
        <!-- Joystick Controls - RESPONSIVE CONTAINER (sm: for better landscape support) -->
        <div class="flex flex-col sm:flex-row sm:space-x-6 space-y-6 sm:space-y-0">
            
            <!-- Motor A (Port 1) - Joystick -->
            <div class="p-4 bg-blue-50 rounded-lg shadow-inner flex-1 relative transition-all duration-300 border-2 border-transparent" id="panel-port-1">
                <!-- Port Status Indicator -->
                <div class="absolute top-4 right-4 flex items-center bg-white/80 px-2 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm">
                    <span id="dot-port-1" class="status-dot"></span> Port 1
                </div>

                <h2 class="text-xl font-bold mb-3 text-blue-700 text-center">Motor A</h2>
                
                <!-- Joystick Area -->
                <div class="flex flex-col items-center">
                    
                    <!-- Config Controls for Motor A - HIDDEN BY DEFAULT -->
                    <div id="configControlsA" class="flex space-x-2 mb-4 w-full justify-center hidden">
                        <select id="orientationA" onchange="updateJoystickLayout(1)" class="p-1 border rounded-lg text-sm">
                            <option value="vertical">Vertical</option>
                            <option value="horizontal">Horizontal</option>
                        </select>
                        <select id="inversionA" onchange="updateJoystickLayout(1)" class="p-1 border rounded-lg text-sm">
                            <option value="normal">Normal</option>
                            <option value="inverted">Inverted (180°)</option>
                        </select>
                    </div>

                    <div class="flex flex-col items-center" id="joystickWrapperA">
                        
                        <!-- Top Label (Vertical) / Left Label (Horizontal) -->
                        <p class="text-xs font-bold mb-1 text-green-600" id="labelPosA">FORWARD (100)</p>
                        
                        <!-- Track and Side Labels Container -->
                        <div class="flex items-center" id="trackContainerA"> 
                            <!-- Left Label (Horizontal) -->
                            <p class="text-xs font-bold mr-2 text-red-600 hidden" id="labelLeftA">LEFT (-100)</p>
                            
                            <!-- Track Element: Initial setup is vertical -->
                            <div class="relative w-12 h-[200px] rounded-xl flex justify-center joystick-track" id="joystickTrackA">
                                <div class="absolute bg-blue-500 rounded-full joystick-handle" id="joystickHandleA"></div>
                            </div>
                            
                            <!-- Right Label (Horizontal) -->
                            <p class="text-xs font-bold ml-2 text-green-600 hidden" id="labelRightA">RIGHT (100)</p>
                        </div>
                        
                        <!-- Bottom Label (Vertical) -->
                        <p class="text-xs font-bold mt-1 text-red-600" id="labelNegA">BACKWARD (-100)</p>
                        
                        <div class="text-center mt-3 text-lg font-bold text-gray-800">Speed: <span id="speedValueA" class="text-blue-600">0</span>%</div>
                    </div>
                </div>
            </div>

            <!-- Motor B (Port 2) - Joystick -->
            <div class="p-4 bg-purple-50 rounded-lg shadow-inner flex-1 relative transition-all duration-300 border-2 border-transparent" id="panel-port-2">
                <!-- Port Status Indicator -->
                <div class="absolute top-4 right-4 flex items-center bg-white/80 px-2 py-1 rounded-full text-xs font-bold text-gray-600 shadow-sm">
                    <span id="dot-port-2" class="status-dot"></span> Port 2
                </div>

                <h2 class="text-xl font-bold mb-3 text-purple-700 text-center">Motor B</h2>

                <!-- Joystick Area -->
                <div class="flex flex-col items-center">
                    <!-- Config Controls for Motor B - HIDDEN BY DEFAULT -->
                    <div id="configControlsB" class="flex space-x-2 mb-4 w-full justify-center hidden">
                        <select id="orientationB" onchange="updateJoystickLayout(2)" class="p-1 border rounded-lg text-sm">
                            <option value="vertical">Vertical</option>
                            <option value="horizontal">Horizontal</option>
                        </select>
                        <select id="inversionB" onchange="updateJoystickLayout(2)" class="p-1 border rounded-lg text-sm">
                            <option value="normal">Normal</option>
                            <option value="inverted">Inverted (180°)</option>
                        </select>
                    </div>

                    <div class="flex flex-col items-center" id="joystickWrapperB">
                        
                        <!-- Top Label (Vertical) / Left Label (Horizontal) -->
                        <p class="text-xs font-bold mb-1 text-green-600" id="labelPosB">FORWARD (100)</p>
                        
                        <!-- Track and Side Labels Container -->
                        <div class="flex items-center" id="trackContainerB"> 
                            <!-- Left Label (Horizontal) -->
                            <p class="text-xs font-bold mr-2 text-red-600 hidden" id="labelLeftB">LEFT (-100)</p>
                            
                            <!-- Track Element: Initial setup is vertical -->
                            <div class="relative w-12 h-[200px] rounded-xl flex justify-center joystick-track" id="joystickTrackB">
                                <div class="absolute bg-purple-500 rounded-full joystick-handle" id="joystickHandleB"></div>
                            </div>
                            
                            <!-- Right Label (Horizontal) -->
                            <p class="text-xs font-bold ml-2 text-green-600 hidden" id="labelRightB">RIGHT (100)</p>
                        </div>
                        
                        <!-- Bottom Label (Vertical) -->
                        <p class="text-xs font-bold mt-1 text-red-600" id="labelNegB">BACKWARD (-100)</p>
                        
                        <div class="text-center mt-3 text-lg font-bold text-gray-800">Speed: <span id="speedValueB" class="text-purple-600">0</span>%</div>
                    </div>
                </div>
            </div>
        </div>
		<hr class="border-gray-200">
		<div class="flex justify-center items-center py-2">
			<a href="https://github.com/sponsors/rmaredia-cloud" target="_blank" 
			   class="flex items-center space-x-2 text-gray-500 hover:text-red-500 transition-colors duration-200 group">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current group-hover:scale-110 transition-transform" viewBox="0 0 24 24">
					<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
				</svg>
				<span class="text-xs font-semibold tracking-wide uppercase">Support the Developer</span>
			</a>
		</div>
    </div>

    <script>
		// Official and working UUIDs
		const OFFICIAL_WEDO_SERVICE_UUID = '00001523-1212-efde-1523-785feabcd123';
		const WORKING_SERVICE_UUID = '00004f0e-1212-efde-1523-785feabcd123';
		const WORKING_MOTOR_CHAR_UUID = '00001565-1212-efde-1523-785feabcd123';
		const WORKING_DEVICE_INFO_CHAR_UUID = '00001527-1212-efde-1523-785feabcd123';

		const CMD_MOTOR_TYPE = 0x01;
		const CMD_MOTOR_ARG = 0x01;

		const STATUS_LABEL = document.getElementById('status');
		const CONNECT_BTN = document.getElementById('connectBtn');
		const DISCONNECT_BTN = document.getElementById('disconnectBtn');
		const TOGGLE_CONTROLS_BTN = document.getElementById('toggleControlsBtn');
		const CONNECTION_CONTROLS_INNER = document.getElementById('connectionControlsInner');
		const CONFIG_CONTROLS_A = document.getElementById('configControlsA');
		const CONFIG_CONTROLS_B = document.getElementById('configControlsB');

		let wedoHub = null;
		let motorCharacteristic = null;
		let deviceInfoCharacteristic = null;

		const commandQueue = [];
		let isWriting = false;

		// Independent tracking for each port
		const joystickState = {
			1: { active: false, pointerId: null, rect: null, maxDist: 0 },
			2: { active: false, pointerId: null, rect: null, maxDist: 0 }
		};

		let lastSentSpeed = { 1: 0, 2: 0 };
		const SPEED_QUANTIZATION = 10;

		const motorConfigs = {
			1: { orientation: 'vertical', inverted: false },
			2: { orientation: 'vertical', inverted: false }
		};

		// UI and Connection Logic
		function toggleConnectionControls() {
			const isHidden = CONNECTION_CONTROLS_INNER.classList.toggle('hidden');
			CONFIG_CONTROLS_A.classList.toggle('hidden', isHidden);
			CONFIG_CONTROLS_B.classList.toggle('hidden', isHidden);
			TOGGLE_CONTROLS_BTN.textContent = isHidden ? 'Show Controls' : 'Hide Controls';
			TOGGLE_CONTROLS_BTN.className = isHidden ? 
				"w-full py-2 bg-gray-400 hover:bg-gray-500 text-white font-semibold rounded-lg text-sm" : 
				"w-full py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg text-sm";
		}

		function updateStatus(connected, text, color) {
			STATUS_LABEL.textContent = text;
			STATUS_LABEL.className = `text-center font-bold text-lg ${color}`;
			if (connected) {
				CONNECT_BTN.classList.add('hidden');
				TOGGLE_CONTROLS_BTN.classList.remove('hidden');
			} else {
				CONNECT_BTN.classList.remove('hidden');
				TOGGLE_CONTROLS_BTN.classList.add('hidden');
				setPortStatus(1, false);
				setPortStatus(2, false);
			}
		}

		function setPortStatus(port, isActive) {
			const dot = document.getElementById(`dot-port-${port}`);
			const panel = document.getElementById(`panel-port-${port}`);
			if (isActive) {
				dot.classList.add('active');
				panel.classList.add('border-green-400');
			} else {
				dot.classList.remove('active');
				panel.classList.remove('border-green-400');
			}
		}

		// Bluetooth Communication Logic
		function calculatePowerByte(speed) {
			if (speed === 0) return 0x00;
			if (speed > 0) return Math.min(100, Math.max(1, speed));
			return 256 + Math.max(-100, Math.min(-1, speed));
		}

		function safeWrite(data, description) {
			commandQueue.push({ data, description });
			processQueue();
		}

		async function processQueue() {
			if (isWriting || commandQueue.length === 0 || !motorCharacteristic) return;
			isWriting = true;
			const cmd = commandQueue.shift();
			try {
				await motorCharacteristic.writeValue(cmd.data);
			} catch (error) {
				console.error(`Write Error: ${error.message}`);
			}
			isWriting = false;
			if (commandQueue.length > 0) setTimeout(processQueue, 25);
		}

		function sendMotorSpeed(port, speed) {
			if (!motorCharacteristic) return;
			const speedQuantized = Math.round(speed / SPEED_QUANTIZATION) * SPEED_QUANTIZATION;
			if (speedQuantized === lastSentSpeed[port] && speed !== 0) return;
			lastSentSpeed[port] = speedQuantized;
			const powerByte = calculatePowerByte(speedQuantized);
			const command = new Uint8Array([port, CMD_MOTOR_TYPE, CMD_MOTOR_ARG, powerByte]);
			safeWrite(command, `Port ${port}: ${speedQuantized}%`);
		}

		// Independent Joystick Logic
		function updateJoystickLayout(port) {
			const prefix = port === 1 ? 'A' : 'B';
			const orientation = document.getElementById(`orientation${prefix}`).value;
			const inverted = document.getElementById(`inversion${prefix}`).value === 'inverted';
			const track = document.getElementById(`joystickTrack${prefix}`);
			const handle = document.getElementById(`joystickHandle${prefix}`);
			const labelPos = document.getElementById(`labelPos${prefix}`);
			const labelNeg = document.getElementById(`labelNeg${prefix}`);
			const labelLeft = document.getElementById(`labelLeft${prefix}`);
			const labelRight = document.getElementById(`labelRight${prefix}`);

			motorConfigs[port] = { orientation, inverted };
			handle.style.top = '50%';
			handle.style.left = '50%';

			track.className = `relative rounded-xl flex justify-center joystick-track ${orientation === 'vertical' ? 'w-12 h-[200px]' : 'h-12 w-[200px]'}`;
			track.style.background = orientation === 'vertical' ? 
				'linear-gradient(to top, #f87171 0%, #fca5a5 49%, #86efac 51%, #4ade80 100%)' :
				'linear-gradient(to right, #f87171 0%, #fca5a5 49%, #86efac 51%, #4ade80 100%)';

			labelPos.classList.toggle('hidden', orientation !== 'vertical');
			labelNeg.classList.toggle('hidden', orientation !== 'vertical');
			labelLeft.classList.toggle('hidden', orientation !== 'horizontal');
			labelRight.classList.toggle('hidden', orientation !== 'horizontal');

			if (orientation === 'vertical') {
				labelPos.textContent = inverted ? 'BACKWARD (-100)' : 'FORWARD (100)';
				labelNeg.textContent = inverted ? 'FORWARD (100)' : 'BACKWARD (-100)';
			} else {
				labelRight.textContent = inverted ? 'LEFT (-100)' : 'RIGHT (100)';
				labelLeft.textContent = inverted ? 'RIGHT (100)' : 'LEFT (-100)';
			}
		}

		function setupJoystick(port) {
			const prefix = port === 1 ? 'A' : 'B';
			const track = document.getElementById(`joystickTrack${prefix}`);
			
			track.addEventListener('pointerdown', (e) => {
				e.preventDefault();
				track.setPointerCapture(e.pointerId); // Locks interaction to this specific pointer/finger
				joystickState[port].active = true;
				joystickState[port].pointerId = e.pointerId;
				joystickState[port].rect = track.getBoundingClientRect();
				
				const handle = document.getElementById(`joystickHandle${prefix}`);
				const size = motorConfigs[port].orientation === 'vertical' ? track.offsetHeight : track.offsetWidth;
				joystickState[port].maxDist = (size - handle.offsetHeight) / 2;
				
				handleMove(e, port);
			});

			track.addEventListener('pointermove', (e) => {
				if (joystickState[port].active && joystickState[port].pointerId === e.pointerId) {
					handleMove(e, port);
				}
			});

			const stop = (e) => {
				if (joystickState[port].pointerId === e.pointerId) {
					joystickState[port].active = false;
					joystickState[port].pointerId = null;
					resetJoystick(port);
				}
			};

			track.addEventListener('pointerup', stop);
			track.addEventListener('pointercancel', stop);
			updateJoystickLayout(port);
		}

		function handleMove(e, port) {
			const state = joystickState[port];
			const prefix = port === 1 ? 'A' : 'B';
			const handle = document.getElementById(`joystickHandle${prefix}`);
			const speedDisplay = document.getElementById(`speedValue${prefix}`);
			const config = motorConfigs[port];
			const handleSize = handle.offsetHeight;
			
			let speed = 0;
			if (config.orientation === 'vertical') {
				let y = e.clientY - state.rect.top;
				y = Math.max(handleSize/2, Math.min(state.rect.height - handleSize/2, y));
				handle.style.top = `${y}px`;
				handle.style.left = '50%';
				let offset = y - (state.rect.height / 2);
				speed = Math.round((offset / state.maxDist) * 100);
				if (!config.inverted) speed = -speed;
			} else {
				let x = e.clientX - state.rect.left;
				x = Math.max(handleSize/2, Math.min(state.rect.width - handleSize/2, x));
				handle.style.left = `${x}px`;
				handle.style.top = '50%';
				let offset = x - (state.rect.width / 2);
				speed = Math.round((offset / state.maxDist) * 100);
				if (config.inverted) speed = -speed;
			}

			speed = Math.max(-100, Math.min(100, speed));
			const displayVal = Math.round(speed / SPEED_QUANTIZATION) * SPEED_QUANTIZATION;
			speedDisplay.innerText = Math.abs(displayVal);
			
			handle.className = `absolute rounded-full joystick-handle ${displayVal > 0 ? 'bg-green-500' : (displayVal < 0 ? 'bg-red-500' : (port === 1 ? 'bg-blue-500' : 'bg-purple-500'))}`;
			sendMotorSpeed(port, speed);
		}

		function resetJoystick(port) {
			const prefix = port === 1 ? 'A' : 'B';
			const handle = document.getElementById(`joystickHandle${prefix}`);
			handle.style.transition = 'all 0.15s ease-out';
			handle.style.top = '50%';
			handle.style.left = '50%';
			handle.className = `absolute rounded-full joystick-handle ${port === 1 ? 'bg-blue-500' : 'bg-purple-500'}`;
			document.getElementById(`speedValue${prefix}`).innerText = '0';
			sendMotorSpeed(port, 0);
			setTimeout(() => handle.style.transition = 'none', 150);
		}

		async function connectHub() {
			if (!navigator.bluetooth) return alert("Bluetooth not supported");
			updateStatus(false, 'Scanning...', 'text-blue-500');
			try {
				wedoHub = await navigator.bluetooth.requestDevice({
					filters: [{ services: [OFFICIAL_WEDO_SERVICE_UUID] }, { namePrefix: 'LPF2' }, { namePrefix: 'WeDo' }],
					optionalServices: [WORKING_SERVICE_UUID]
				});
				wedoHub.addEventListener('gattserverdisconnected', onDisconnected);
				const server = await wedoHub.gatt.connect();
				const service = await server.getPrimaryService(WORKING_SERVICE_UUID);
				motorCharacteristic = await service.getCharacteristic(WORKING_MOTOR_CHAR_UUID);
				
				try {
					deviceInfoCharacteristic = await service.getCharacteristic(WORKING_DEVICE_INFO_CHAR_UUID);
					await deviceInfoCharacteristic.startNotifications();
					deviceInfoCharacteristic.addEventListener('characteristicvaluechanged', (e) => {
						const port = e.target.value.getUint8(0);
						if (port === 1 || port === 2) setPortStatus(port, true);
					});
				} catch (e) {}
				updateStatus(true, 'Connected', 'text-green-600');
			} catch (e) {
				updateStatus(false, 'Failed', 'text-red-500');
			}
		}

		function disconnectHub() {
			if (wedoHub) wedoHub.gatt.disconnect();
		}

		function onDisconnected() {
			updateStatus(false, 'Disconnected', 'text-red-500');
			wedoHub = null;
			motorCharacteristic = null;
		}

		document.addEventListener('DOMContentLoaded', () => {
			setupJoystick(1);
			setupJoystick(2);
		});
    </script>
</body>
</html>

